# Chapter 13. 교착 상태

## 13-1. 교착 상태란

- 일어나지 않을 사건을 기다리며 무한히 대기 하는 현상
- 교착 상태 발생 예시 : 식사하는 철학자 문제
- 자원 할당 그래프 → 교착 상태 표현
- 교착 상태 발생 조건
    - 상호 배제
    - 점유와 대기
    - 비선점
    - 원형 대기

### 식사하는 철학자 문제

- 한두 명의 철학자가 식사할 때는 아무런 문제가 없다가,
  모든 철학자들이 동시에 포크를 집어 식사를 하게 되면 어떤 철학자도 식사를 할 수 없고 영원히 생각만 하는 상황이 발생할 수 있음
- 모든 철학자가 왼쪽 포크를 집어들면 모두가 오른쪽 포크를 집어 들 수 없음
- 모든 철학자는 다른 철학자가 포크를 내려놓을 때까지 기다림

⇒ 일어나지 않을 사건을 기다리며 진행이 멈춰 버리는 현상

교착 상태(deadlock)

- 철학자 - 프로세스 혹은 스레드,
- 포크 - 자원
- 생각하는 행위 - 자원을 기다리는 것
- 포크는 한 번에 하나의 프로세스 혹은 스레드만 접근 - 임계 구역

### 자원 할당 그래프(resource-allocation graph)

어떤 프로세스가 어떤 자원을 사용하고 있고, 어떤 프로세스가 어떤 자원을 기다리고 있는지 표현

- 프로세스 - 원
- 자원의 종류 - 사각형
- 사용할 수 있는 자원의 개수 - 자원 사각형 내에 점으로 표현
- 프로세스가 어떤 자원을 할당받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시
- 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표를 표시
- 자원 할당 그래프가 원의 형태인 경우 → 교착상태

### 교착 상태 발생 조건

- 조건 중 하나라도 만족하지 않으면 교착 상태가 발생하지 않지만, 아래 조건이 모두 만족하면 교착 생태가 발생할 수 있음
    1. 상호 배제
    2. 점유와 대기
    3. 비선점
    4. 원형 대기

- **상호 배제**(mutual exclusion)
    - 프로세스 또한 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없을 때
    - 해당 자원을 한 번에 하나의 프로세스만 이용 가능

- **점유와 대기**(hold and wait)
    - 자원을 할당받은 상태에서 다른 자원 할당 대기하는 상태
    - 자원을 보유한 채 다른 자원을 기다리기 때문

- **비선점**(nonpreemptive)
    - 프로세스가 자원을 비선점
    - 비선점 자원은 그 자원을 이용하는 프로세스의 작업이 끝나야면 비로소 이용가능
    - 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못해 교착상태 발생

- **환형 대기**(circular wait)
    - 프로세스들이 원의 형태로 자원을 대기하는 것
    - 자원 할당 그래프가 원의 형태로 그려지면 교착 상태가 발생할 수 있음

## 13-2. 교착 상채 해결 방법

- 예방 : 교착 상태 발생 조건에 부합하지 않게 자원을 분해
- 회피 : 교착 상태가 발생하지 않을 정도로 조금씩 자원을 할당하다가 교착 상태의 위험이 있다면 자원을 할당하지 않음
- 검출 후 회복 : 자원을 제약 없이 할당하다가 교착 상태가 검출 되면 교착 상태를 회복하는 방법

### 교착 상태 예방

교착 상태 발생 필요 조건 중 네 가지 중 하나를 충족하지 못하게 하는 방법

⇒ 교착 상태가 발생하지 않음을 보장할 수는 있지만 여러 부작용이 따름

- **자원의 상호 배제 불충족**
    - 모든 자원을 공유 가능 → 현실적으로 어려움

- **점유와 대기 불충족**
    - 점유와 대기를 없애면 운영체제는 특정 프로세스에 자원을 모두 할당하거나, 아예 할당하지 않는 방식으로 배분
    - 자원의 활용율이 낮아질 우려 발생
        - 당장 자원이 필요해도 기다릴 수 밖에 없는 프로세스, 사용되지 않으면서 오랫동안 할당되는 자원
    - 기아 현상 : 많은 자원을 필요로 하는 프로세스가 무한정 대기
        - 점유와 대기를 금지하면 많은 자원을 사용하는 프로세스 불리
            - 자원을 많이 사용하는 프로세스는 자원을 적게 사용하는 프로세스에 비해 동시에 자원을 사용할 타이밍 확보 어려움
            -
- **비선점 불충족**
    - 자원을 이용 중인 프로세스로부터 해당 자원을 빼앗을 수 있음
        - 선점하여 사용할수 있는 일부 자원에 대해서는 효과적(CPU)
    - 모든 자원 선점 가능 X
        - 한 프로세스의 작업이 끝날 때까지 다른 프로세스가 기다려야 하는 자원이  있음

          →다소 범용성이 떨어짐


- **원형 대기 불충족**
    - 모든 자원에 번호를 붙이고 오름차순으로 자원 할당
    - 상대적으로 앞선 세 방식에 비하면 비교적 현실적, 실용적
    - 모든 컴퓨터 시스템 내에 존재하는 수많은 자원에 번호를 붙이는 일은 간단한 작업이 아님
    - 각 자원에 어떤 번호를 붙이는지에 따라 특정 자원의 활용률이 떨어질 수 있음

### 교착 상태 회피

- 프로세스들에 배분할 수 있는 자원의 양을 고려하여 교착 상태가 발생하지 않을 정도로의 양만큼만 자원을 배분하는 방법
    - 교착 상태를 한정된 자원의 무분별한 할당으로 인해 발생하는 문제로 간주
    - 자원이 한정된 상황에서 모든 프로세스들이 한 번에 많은 자원을 요구하면 교착 상태가 발생할 위험 증가
    - 안전 상태로 유지하도록 자원을 할당

- 안전 상태 (safe state) : 교착 상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당받고 종료될 수 있는 상태
- 불안전 상태 (unsafe sate) : 교착 상태가 발생할 수도 있는 상태(안전 순서열이 없는 상황)
- 안전 순서열 (safe sequence) : 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서

### 교착 상태 검출 후 회복

교착 상태 발생을 인정하고 사후에 조치하는 방식

- **선점을 통한 회복**
    - 교착 상태가 해결될 때까지 한 프로세스씩 자원을 몰아주는 방식
    - 다른 프로세스로부터 자원을 강제로 빼앗고 한 프로세스에 할당

- **프로세스 강제 종료를 통한 회복**
    - 가장 단순, 확실
    - 교착 상태에 놓인 프로세스 모두 강제 종료
        - 교착 상태를 해결할 수 있는 가장 확실한 방법
        - 많은 프로세스들이 작업 내역을 잃게 될 가능성
    - 교착 상태가 없어질 때까지 한 프로세스씩 강제 종료
        - 작업 내역을 잃는 프로세스는 최대한 줄일 수 있음
        - 교착 상태가 없어졌는지 여부를 확인하는 과정에서 오버헤드 발생 우려