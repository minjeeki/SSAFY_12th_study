# 12-1. 동기화란

### **동기화**(synchronization)

- 프로세스들 사이의 수행 시기를 맞추는 것
- 운영체제의 프로세스 관리 서비스 중 하나 (스케줄링, 동기화)
- 공동의 목적을 갖고 협력하여 실행되는 프로세스들의 실행 순서 및 자원의 일관성 보장
- 동기화 대상
    - 실행의 흐름을 갖는 모든 것(프로세스, 스레드 )

### **프로세스 동기화**

- 실행 순서 제어: 프로세스를 올바른 순서대로 실행
- 상호 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근

- **생산자와 소비자 문제**
    - 상호 배제를 위한 동기화에 대한 문제
        - 동시에 접근해서는 안 되는 자원에 동시에 접근하여 발생
    - 예시
        - 생산자 :  물건을 계속해서 생산하는 프로세스
        - 소비자 : 물건을 계속해서 소비하는 프로세스

          → 생산자와 소비자는 동시에 실행되는 스레드가 될 수 있음


### **공유 자원과 임계 구역**

- 공유 자원(shared resource)
    - **공동으로 이용하는 변수, 파일, 장치 등**
- 임계 구역(critical section)
    - **공유 자원에 접근하는 코드 중 동시에 실행하면 문제가 발생하는 코드 영역**
    - 두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기
    - 임계 구역에 먼저 진입한 프로세스의 작업 끝난 후 다음 프로세스가 임계 구역 진입
- 레이스 컨디션(race condition)
    - 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드 실행 → 문제 발생
    - 데이터의 일관성이 깨지는 문제 발생

- 상호 배제를 위한 동기화를 위한 원칙
    - 상호 배제(mutual exclusion) : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역 진입 X
    - 진행(progress) : 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있음
    - 유한 대기(bounded waiting) : 임계 구역에 들어오기 위해 무한정 대기해서는 안됨 (한 프로세스가 임계 구역에 진입하고 싶다면 언젠가는 임계 구역 진입)

# 12-2. 동기화 기법

### 뮤텍스 락(Mutex lock:MUTual Exclusion lock)

- 상호 배제를 위한 동기화 도구
- ‘탈의실 이용’  비유
    - 손님 : 프로세스, 탈의실 : 임계 구역
    - 탈의실 자물쇠가 걸려있으면 사람이 있다고 판단. 자물쇠가 걸려 있지 않으면 탈의실 이용
- 구현
    - 자물쇠 역할 : 프로세스들이 공유하는 전역 변수 lock
    - 임계 구역을 잠그는 역할 : acquire 함수
    - 임계 구역의 잠금을 해제하는 역할 : release 함수

- acquire : 프로세스가 임계 구역에 진입하기 전에 호출
    - 잠겨있는 경우 : 임계 구역이 열릴 때까지(lock이 false가 될 때까지) 반복 확인

      → 바쁜 대기(busy wait)

    - 열려있는 경우 : 임계 구역 잠금(lock을 true로 변환)
- release : 임계 구역에서의 작업이 끝나고 호출
    - 잠긴 임계 구역을 열어 주는(lock을 false로 바꾸는) 함수

### 세마포(semaphore)

- 공유 자원이 여러 개 있을 경우(탈의실이 여러 개 있는 경우)
    - 이진 세마포(binary semaphore) →  뮤텍스 락과 비슷한 개념
    - 카운팅 세마포(counting semaphore)
- 구현
    - 전역 변수 S : 임계 구역에 진입할 수 있는 프로세스 개수(사용 가능한 공유 자원의 개수)
        - 진입 시 : S 1감소
        - 작업 마친 후 : S 1 증가
    - wait 함수 : 임계 역에 들어가도 좋은지, 기다려야 할지 결정
        - S = 0 → 사용할 수 있는 자원있는지 확인
    - signal 함수 : 임계 구역 앞에서 기다리는 프로세스에 진입 신호
- 상호 배제를 위한 동기화 구현
    - wait 함수가 사용할 수 있는 자원이 없으면, 해당 프로세스를 대기 상태로 전환
    - 프로세스의 PCB를 세마포를 위한 대기 큐에 넣음
    - 다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수 호출
    - signal 함수는 대기 중인 프로세스를 대기 큐에서 제거
    - 프로세스를 준비 상태로 변경한 뒤 준비 큐로 옮김

- 실행 순서 제어를 위한 동기화
    - 세마포의 변수 S를 0으로 설정
    - 먼저 실행할 프로세스 뒤에 signal 함수, 다음에 실행할 프로세스 앞에 wait 함수를 붙임

  ⇒ 매번 임계 구역에 앞뒤로 wait이나 signal 함수를 명시→ 불편


### 모니터(monitor)

- 세마포에 비해 사용자에게 편리한 도구
- 공유 자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 묶어 관리
- 프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근
    - 모니터를 통해 공유 자원에 접근하고자 하는 프로세스를 큐에 삽입

      (큐에 삽입된 순서대로 하나씩 공유 자원 이용) → 상호 배제를 위한 동기화

- 조건 변수(condition variable) : 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수
    - 특정 프로세스 실행 조건 불충족 시 : wait을 통해 실행 중단
    - 특정 프로세스 실행 조건 충족 시 : signal을 통해 실행을 재개