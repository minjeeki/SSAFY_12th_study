# 가상 메모리 (Virtual Memory)

: 컴퓨터 시스템의 메모리 관리 기법 => 물리적인 메모리의 크기를 확장된 방식으로 사용할 수 있게 함

- 물리 메모리와 저장 장치를 결합하여 메모리를 효율적으로 관리 & 프로그램 실행 성능 높이는데 기여

## 가상 메모리 동작 원리

### 가상 메모리의 기본 원리 : 스와핑 (Swapping)

- 메모리에 적재된 프로세스 중에는 현재 실행되지 않은 프로세스가 있을 수 있음 (입출력 작업 대기중 or 오랫동안 사용되지 않은 프로세스)

  => 미실행 프로세스를 보저기억장치 일부 영역으로 쫓아냄 & 해당 공간에 다른 프로세스 적재 후 실행

- 스왑 영역 : 프로세스들이 쫓겨나는 보조기억장치의 일부 영역

- 스왑 아웃 : 현재 실행되지 않는 프로세스가 메모리 -> 스왑 영역으로 이동

- 스왑 인 : 프로세스가 스왑 영역 -> 메모리로 이동

  - 스왑 인될 때는 스왑 아웃되기 전 물리 주소와 다른 주소에 적재될 수 있음

- 리눅스, macOS에서 스왑 영역 확인 명령어 : `free`, `top`

  - 스왑 영역의 크기와 사용 여부는 사용자가 임의로 설정할 수 있음

### 가상 메모리의 할당 원리 : 메모리 할당

> 메모리 내에 빈 공간이 여러개 있다면 3가지 방식 (최초 적합, 최적 적합, 최악 적합)을 이용해 프로세스를 배치할 수 있다.

1. 최초 적합 (first fit) : 운영체제가 메모리 내 빈 공간을 순서대로 검색하다가 적재할 수 있는 공간을 발견하며 해당 공간에 프로세스를 배치

  - 검색 최소화하기에 빠른 할당이 가능함

2. 최적 적합 (best fit) : 운영체제가 빈 공간을 모두 검색해본 후 프로세스가 적재될 수 있는 공간 중 가장 작은 공간에 프로세스를 배치

3. 최악 적합 (worst fit) : 운영체제가 빈 공간을 모두 검색해본 후 프로세스가 적재될 수 있는 공간 중 가장 큰 공간에 프로세스를 배치

### 메모리 할당 중 발생할 수 있는 문제 : 외부 단편화 (External Fragmentation)

: 사용 가능한 전체 메모리 공간은 충분하지만 작은 조각들로 나뉘어져 있어서 실제로 메모리를 할당할 수 없는 상황

- 메모리를 동적으로 할당하고 해제하는 과정에서 발생

- 외부 단편화 해결 방법

  - 메모리 압축 (Memory Compaction) : 단편화된 작은 빈 공간을 하나로 합쳐서 큰 연속된 메모리 블록을 만드는 방법

    => 메모리 공간을 보다 효율적으로 사용 가능

    => 시스템 성능에 부담을 줄 수 있으며, 시간이 많이 소요되는 작업일 수 있음

  - 페이징 (Paging) : 물리 메모리를 고정 크기의 페이지로 나뉘어 관리 (메모리와 프로세스를 일정한 단위로 자르고 이를 메모리에 불연속적으로 적재)

    => 외부 단편화 효과적으로 방지 가능

  - 세그멘테이션 (Segmentation) : 프로세스를 논리적인 세그먼트로 나누어 할당하는 기법

    => 단일 방법으로 외부 단편화 문제 최소화 가능

## 가상 메모리의 장단점

### 가상 메모리의 장점

1. 효율적인 메모리 사용 : 모든 프로그램이 실행될 때 물리 메모리에 전부 로드될 필요가 없기에 여러 프로그램을 동시에 실행 가능

  => 필요한 메모리만 물리 메모리에 올리므로 메모리 사용이 최적화

2. 프로세스 간 메모리 보호 : 각 프로세스는 독립된 가상 주소 공간을 사용하기에 다른 프로세스의 메모리 영역을 침범하지 않음 => 시스템 안정성과 보안 높임

3. 메모리 크기 확장 : 물리 메모리 용량이 한정되어 있어도 가상 메모리 통해 더 큰 메모리 공간을 사용하는 것처럼 동작할 수 있어 대형 프로그램도 실행 가능

4. 프로그램 적재 유연성 : 프로그램 전체 코드와 데이터를 한번에 적재하지 않고 실행 도중에 필요한 부분만 메모리로 불러오는 지연 적재 (lazy loading) 기법을 사용할 수 있음

  => 프로그램의 메모리 사용 효율 높일 수 있음

### 가상 메모리의 단점

1. 페이지 폴트 (Page Fault) : 프로세스가 참조하는 페이지와 물리 메모리에 없을 경우 페이지 폴트가 발생하여 저장 장치에서 해당 페이지를 불러와야 하기에 시간 소요 & 성능 저하 발생

2. 스왑 공간 과다 사용 : 물리 메모리 부족할 경우 스왑 영역으로 많은 페이지가 이동하며 스레싱 현상 발생 가능

  - 스레싱 현상 : 페이지 교체 작업이 빈번하게 발생해 CPU가 실제 작업을 거의 하지 못하게 되는 상황

## 페이징

: 물리 메모리를 고정 크기의 페이지로 나뉘어 관리 (메모리와 프로세스를 일정한 단위로 자르고 이를 물리적인 메모리에 불연속적으로 적재)

### 페이징 관련 단위

- 페이지 : 프로세스의 논리 주소 공간을 자르는 단위

- 프레임 : 메모리 물리 주소 공간을 자르는 단위

### 페이징 테이블

: 프로세스가 메모리 물리 주소에 불연속적으로 배치되더라도 CPU가 바라보는 주소인 논리 주소에는 연속적으로 배치되도록 페이지 테이블을 이용함

- 페이지 테이블 베이스 레지스터 (PTBR) : 각 프로세스의 페이지 테이블이 적재된 주소를 가리키는 것 (CPU 내부에 존재)

### 페이징이 야기할 수 있는 문제 : 내부 단편화

: 프로세스에 할당된 메모리 블록이 실제 필요한 메모리보다 클 때, 할당된 메모리 블록 안에서 낭비되는 공간이 발생하는 현상