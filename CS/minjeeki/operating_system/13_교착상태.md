# 교착상태

## 교착상태 (deadlock)

: 일어나지 않을 사건을 기다리며 진행이 멈춰 버리는 현상

=> 둘 이상의 프로세스나 스레드가 서로 자원을 점유한 상태에서 다른 프로세스가 점유하고 있는 자원을 요청하며 무한정 대기하는 상황 (모든 프로세스가 서로가 가진 자원을 기다리면서 멈춰 어떤 작업도 진행되지 않음)

### 자원 할당 그래프 : 교착 상태 발생 상황 파악하기

> 교착 상태가 발생했을 때의 상황을 표현 => 자원 할당 그래프 통해 표현

  - 자원 할당 그래프 : 어떤 프로세스가 어떤 자원을 사용 중이고 어떤 프로세스가 어떤 자원을 기다리고 있는지 표현한 그래프

    규칙 (1) 프로세스는 원으로, 자원은 사각형으로 표현

    규칙 (2) 사용할 수 있는 자원의 개수는 자원 사각형 내 점으로 표현

    규칙 (3) 프로세스가 어떤 자원을 할당 받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시

    규칙 (4) 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원을 화살표를 표시

  - 교착 상태가 발생할 수 있는 상황 : 자원 할당 그래프가 원의 형태를 띄고 있음 

### 교착 상태 발생 조건 4가지 (상호 배제, 점유와 대기, 비선점, 원형 대기)

> 교착 상태가 일어나는 근본적인 이유에 대해 파악 => 해결 가능

1. 상호 배제 (mutual exclusion) : 해당 자원을 한번에 하나의 프로세스만 사용

2. 점유와 대기 (hold and wait) : 자원을 할당받은 상태에서 다른 자원을 할당받기 기다림

3. 비선점 (nonpreemptive) : 프로세스가 자원을 비선점하는 상황 (프로세스가 다른 프로세스의 자원을 강제로 빼앗지 못함)

4. 원형 대기 (circular wait) : 자원 할당 그래프가 원의 형태로 그려지는 상황

  - 자원 할당 그래프가 원의 형태를 띈다고 해서 반드시 교착 상태가 발생하는 것은 아니다.

### 교착 상태 해결 방법

1. 교착 상태 `예방`

  : 발생 필요 조건 4가지 중 하나를 충족하지 못하게 하는 방법

  - 상호배제 충족 X : 모든 자원을 공유 가능하게 한다

    => 이론적으로만 가능 (현실 적용에는 무리가 있음)

  - 점유와 대기 충족 X : 특정 프로세스에 자원 모두 할당 또는 아예 할당 X

    => 단점 : 자원 활용률 낮아짐 & 자원 많이 사용하는 프로세스에게 불리함 (기아 현상 발생 위험 높음)

  - 비선점 충족 X : 프로세스로부터 자원 빼앗기

    => 일부 효과적인 상황 있으나 모든 자원에 적용 불가 (범용성 떨어짐)

  - 원형 대기 충족 X : 자원에 번호 부여 & 오름차순 자원 할당

    => 단점 : 컴퓨터 시스템 내 모든 자원에 번호 붙이기 어려움, 번호에 따라 자원 활용률 떨어짐

    > 교착상태 예방은 교착상태 발생을 보장할 수 있으나 부작용 많음

2. 교착 상태 `회피`

  : 교착 상태가 발생하지 않을 정도로만 자원을 할당

  - 기본 용어

    - 안전 순서열 (safe sequence) : 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서

    - 안전 상태 (safe state) : 교착상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당받고 종료될 수 있는 상태

      => 안전 순서열대로 프로세스들에 자원을 배분해 교착상태가 발생 X

    - 불안전 상태 (unsafe state) : 교착상태가 발생할 수도 있는 상황

      => 안전 순서열이 없는 상태
    
    > 시스템 상태가 안전 상태에서 안전 상태로 움직이는 경우에만 자원 할당 (항상 안전 상태를 유지하도록 자원 할당)

3. 교착 상태 `검출` 후 `회복`

  : 교착 상태 발생을 인정하고 사후에 조치하는 방식

  - 회복 방식

    1. 선점을 통한 회복 : 교착상태가 해결될 때까지 한 프로세스씩 자원 몰아주기 (강제 빼앗기 & 몰아주기)

    2. 프로세스 강제 종료를 통한 회복
    
      - 교착상태에 놓인 프로세스 강제 종료 : 가장 확실한 방식이나 작업 내역 잃을 가능성 있음
      
      - 교착 상태가 없어질 때까지 한 프로세스씩 강제 종료 : 작업 내역 잃는 프로세스는 최대한 줄일 수 있으나 교착 상태 소멸 여부 확인 작업 반복적 필요 (오버헤드)

## 문제 리스트

1. 교착 상태 발생 조건에 대해 설명하세요.

  ```markdown
  교착상태는 다음 네 가지 조건이 동시에 만족될 때 발생합니다.

  1. 상호 배제(Mutual Exclusion): 자원은 한 번에 하나의 프로세스만 사용할 수 있어야 합니다.
  2. 점유 대기(Hold and Wait): 자원을 점유한 상태에서 다른 자원을 추가로 기다리는 프로세스가 있어야 합니다.
  3. 비선점(Non-preemption): 프로세스가 자원을 강제로 빼앗기지 않고, 스스로 해제할 때까지 자원을 점유할 수 있어야 합니다.
  4. 순환 대기(Circular Wait): 자원과 프로세스 사이에 순환적인 대기 관계가 있어야 합니다. 즉, 프로세스 A가 자원 1을 점유하고 자원 2를 기다리는 상황에서, 프로세스 B는 자원 2를 점유하고 자원 1을 기다리는 형태의 순환이 발생해야 합니다.
  ```

2. 교착 상태 예방 방법에 대해 설명하세요.

  ```markdown
  교착상태 예방은 교착상태가 발생하지 않도록 4가지 조건 중 하나 이상을 만족하지 않게 하는 방식입니다. 대표적인 방법은 다음과 같습니다.

  1. 상호 배제 방지: 자원을 공유할 수 있게 만드는 것입니다. 하지만 공유할 수 없는 자원(예: 프린터)도 있기 때문에 이 방법은 제한적입니다.
  2. 점유 대기 방지: 프로세스가 자원을 요청할 때, 이미 필요한 자원을 모두 한 번에 할당하거나, 자원을 점유하고 있는 상태에서는 추가 자원을 요청하지 못하게 합니다.
  3. 비선점 방지: 자원을 점유하고 있는 프로세스가 다른 자원을 요청할 때, 기존에 점유한 자원을 강제로 회수하여 다른 프로세스에 할당할 수 있게 합니다.
  4. 순환 대기 방지: 자원에 고유한 순서를 부여하고, 프로세스는 오직 순서대로 자원을 요청하게 하여 순환적인 대기 상태가 발생하지 않도록 합니다.
  ```

3. (추가 문제) 교착상태를 해결하기 위한 회피 전략으로 사용되는 은행가 알고리즘을 설명하세요.

  ```markdown
  은행가 알고리즘은 교착상태 회피 기법 중 하나로, 자원을 요청할 때 시스템이 안전 상태인지 확인하고, 안전한 경우에만 자원을 할당하는 방식입니다. 이를 통해 교착상태가 발생하지 않도록 관리합니다.

  - 안전 상태(Safe State): 프로세스가 자원을 요청할 때, 그 요청을 만족시킨 후에도 시스템이 교착상태에 빠지지 않고 모든 프로세스가 실행을 마칠 수 있는 상태를 의미합니다.
  - 알고리즘 동작:
    1. 각 프로세스가 최대 얼마나 많은 자원을 요구할 수 있는지 미리 파악합니다.
    2. 프로세스가 자원을 요청하면, 그 자원을 할당한 후 시스템이 안전 상태로 남아 있는지 확인합니다.
    3. 만약 자원을 할당한 후에도 시스템이 안전 상태라면, 자원을 할당합니다. 그렇지 않다면, 자원을 할당하지 않고 대기하게 만듭니다.
  이 알고리즘은 주로 자원의 동적 할당이 필요한 시스템에서 사용됩니다.
  ```